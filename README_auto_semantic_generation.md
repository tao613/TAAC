# è‡ªåŠ¨Semantic IDç”ŸæˆåŠŸèƒ½

æœ¬æ–‡æ¡£è¯´æ˜åœ¨æ¨ç†é˜¶æ®µè‡ªåŠ¨ç”Ÿæˆsemantic_idç‰¹å¾çš„æ–°åŠŸèƒ½ã€‚

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ç°åœ¨`evalu/infer.py`å…·å¤‡äº†**æ™ºèƒ½semantic_idç”Ÿæˆ**åŠŸèƒ½ï¼Œå½“æ£€æµ‹åˆ°ç¼ºå°‘semantic_idæ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨ï¼š

1. **åŠ è½½å¤šæ¨¡æ€ç‰¹å¾** 
2. **å¿«é€Ÿè®­ç»ƒRQ-VAEæ¨¡å‹**
3. **ç”Ÿæˆsemantic_idç‰¹å¾**
4. **ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­ä½¿ç”¨**
5. **æ— ç¼é›†æˆåˆ°æ¨ç†æµç¨‹**

## ğŸ”„ è‡ªåŠ¨ç”Ÿæˆå·¥ä½œæµç¨‹

### 1. **æ£€æµ‹é˜¶æ®µ**
```python
semantic_id_dict = test_dataset.semantic_id_dict
if semantic_id_dict:
    print(f"æˆåŠŸåŠ è½½ {len(semantic_id_dict)} ä¸ªç‰©å“çš„semantic_idç‰¹å¾")
else:
    print("æœªæ‰¾åˆ°semantic_idç‰¹å¾ï¼Œå°è¯•è‡ªåŠ¨ç”Ÿæˆ...")
```

### 2. **è‡ªåŠ¨è®­ç»ƒRQ-VAE**
```python
# æŒ‰éœ€ç”Ÿæˆsemantic_idç‰¹å¾
semantic_id_dict = generate_semantic_ids_on_demand(
    data_path=data_path,
    mm_emb_ids=args.mm_emb_id,  # ä½¿ç”¨æ¨ç†å‚æ•°ä¸­çš„å¤šæ¨¡æ€ç‰¹å¾ID
    args=args
)
```

### 3. **ç”Ÿæˆè¿‡ç¨‹**
- âœ… **åŠ è½½å¤šæ¨¡æ€ç‰¹å¾**: ä»`creative_emb`ç›®å½•åŠ è½½ç‰¹å¾ID 81ç­‰
- âœ… **æ•°æ®é¢„å¤„ç†**: åˆå¹¶å¤šä¸ªç‰¹å¾IDï¼Œå¯¹å¤šç‰¹å¾ç‰©å“å–å¹³å‡
- âœ… **RQ-VAEè®­ç»ƒ**: 20è½®å¿«é€Ÿè®­ç»ƒï¼Œé€‚åˆæ¨ç†æ—¶ä½¿ç”¨
- âœ… **semantic_idç”Ÿæˆ**: ä¸ºæ‰€æœ‰ç‰©å“ç”Ÿæˆ4ç»´è¯­ä¹‰IDåºåˆ—
- âœ… **æ–‡ä»¶ä¿å­˜**: ä¿å­˜åˆ°`semantic_id_dict.json`ä¾›åç»­ä½¿ç”¨

## ğŸ“Š é¢„æœŸæ—¥å¿—è¾“å‡º

### æƒ…å†µ1ï¼šé¦–æ¬¡è¿è¡Œï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```
æœªæ‰¾åˆ°semantic_idç‰¹å¾ï¼Œå°è¯•è‡ªåŠ¨ç”Ÿæˆ...
æ­£åœ¨ç”Ÿæˆsemantic_idç‰¹å¾...
åŠ è½½å¤šæ¨¡æ€ç‰¹å¾ç”¨äºRQ-VAEè®­ç»ƒ...
Loading mm_emb: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:06<00:00, 6.85s/it]
Loaded #81 mm_emb
è·å–äº† 50000 ä¸ªç‰©å“çš„å¤šæ¨¡æ€ç‰¹å¾ï¼Œç»´åº¦: 32
å¼€å§‹è®­ç»ƒRQ-VAEæ¨¡å‹...
Epoch 5/20: Loss=0.0234
Epoch 10/20: Loss=0.0156  
Epoch 15/20: Loss=0.0123
Epoch 20/20: Loss=0.0098
RQ-VAEè®­ç»ƒå®Œæˆï¼
ç”Ÿæˆsemantic_id...
ä¸º 50000 ä¸ªç‰©å“ç”Ÿæˆäº†semantic_id
ä¿å­˜semantic_idåˆ° /data_ams/infer_data/semantic_id_dict.json
semantic_idç”Ÿæˆå’Œä¿å­˜å®Œæˆï¼
æˆåŠŸç”Ÿæˆ 50000 ä¸ªç‰©å“çš„semantic_idç‰¹å¾
```

### æƒ…å†µ2ï¼šåç»­è¿è¡Œï¼ˆç›´æ¥ä½¿ç”¨ï¼‰
```
æˆåŠŸåŠ è½½ 50000 ä¸ªç‰©å“çš„semantic_idç‰¹å¾
```

## âš™ï¸ é…ç½®å‚æ•°

### RQ-VAEè®­ç»ƒå‚æ•°ï¼ˆæ¨ç†ä¼˜åŒ–ç‰ˆï¼‰
```python
num_quantizers = 4      # è¯­ä¹‰IDåºåˆ—é•¿åº¦
codebook_size = 256     # æ¯ä¸ªä½ç½®çš„å–å€¼èŒƒå›´
commitment_cost = 0.25  # é‡åŒ–æŸå¤±æƒé‡
lr = 1e-3              # å­¦ä¹ ç‡
num_epochs = 20        # å‡å°‘è®­ç»ƒè½®æ•°ï¼Œå¿«é€Ÿç”Ÿæˆ
batch_size = 1024      # æ‰¹æ¬¡å¤§å°
```

è¿™äº›å‚æ•°ä¸“é—¨ä¸ºæ¨ç†é˜¶æ®µä¼˜åŒ–ï¼Œå¹³è¡¡äº†ç”Ÿæˆè´¨é‡å’Œæ—¶é—´æ•ˆç‡ã€‚

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šå®Œå…¨è‡ªåŠ¨åŒ–ï¼ˆæ¨èï¼‰
```bash
# ç›´æ¥è¿è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å’Œç”Ÿæˆ
python evalu/infer.py

# é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆsemantic_idï¼ˆå¢åŠ 2-3åˆ†é’Ÿï¼‰
# åç»­è¿è¡Œç›´æ¥ä½¿ç”¨å·²ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆç§’çº§åŠ è½½ï¼‰
```

### æ–¹æ³•2ï¼šé¢„ç”Ÿæˆï¼ˆå¯é€‰ï¼‰
```bash
# å¦‚æœæƒ³é¢„å…ˆç”Ÿæˆsemantic_idç‰¹å¾
python train_rqvae.py \
    --data_dir /path/to/data \
    --output_dir /path/to/output

cp /path/to/output/semantic_id_dict.json /data_ams/infer_data/
python evalu/infer.py
```

## ğŸ“ˆ æ€§èƒ½å½±å“

### é¦–æ¬¡è¿è¡Œ
- **é¢å¤–æ—¶é—´**: 2-3åˆ†é’Ÿï¼ˆRQ-VAEè®­ç»ƒ + semantic_idç”Ÿæˆï¼‰
- **å†…å­˜æ¶ˆè€—**: ä¸´æ—¶å¢åŠ çº¦500MBï¼ˆè®­ç»ƒæœŸé—´ï¼‰
- **å­˜å‚¨**: ç”Ÿæˆçº¦10-20MBçš„semantic_id_dict.jsonæ–‡ä»¶

### åç»­è¿è¡Œ
- **åŠ è½½æ—¶é—´**: 1-2ç§’ï¼ˆJSONæ–‡ä»¶è¯»å–ï¼‰
- **å†…å­˜æ¶ˆè€—**: åŸºæœ¬æ— é¢å¤–æ¶ˆè€—
- **æ¨ç†è´¨é‡**: æ˜¾è‘—æå‡ï¼ˆç‰¹åˆ«æ˜¯é•¿å°¾ç‰©å“ï¼‰

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å¤šæ¨¡æ€ç‰¹å¾å¤„ç†
```python
# æ”¯æŒå¤šä¸ªç‰¹å¾IDï¼Œè‡ªåŠ¨åˆå¹¶
for feat_id in mm_emb_ids:  # å¦‚['81', '82', '83']
    if feat_id in mm_emb_dict:
        # ä¸ºæ¯ä¸ªç‰©å“æ”¶é›†æ‰€æœ‰ç‰¹å¾
        for item_id, emb in feat_embs.items():
            item_embeddings[item_id].append(emb)

# å¤šç‰¹å¾å–å¹³å‡
final_embeddings[item_id] = np.mean(emb_list, axis=0)
```

### å¿«é€Ÿè®­ç»ƒç­–ç•¥
```python
# æ¨ç†æœŸé—´çš„è®­ç»ƒä¼˜åŒ–
num_epochs = 20          # ç›¸æ¯”å®Œæ•´è®­ç»ƒçš„50è½®
batch_size = 1024        # è¾ƒå¤§æ‰¹æ¬¡ï¼Œæé«˜æ•ˆç‡
print_frequency = 5      # å‡å°‘æ—¥å¿—è¾“å‡º
```

### è‡ªåŠ¨æ–‡ä»¶ç®¡ç†
```python
# ä¿å­˜åˆ°æ¨ç†æ•°æ®ç›®å½•
semantic_id_file = Path(data_path) / 'semantic_id_dict.json'

# è‡ªåŠ¨é‡æ–°åŠ è½½datasetè·å–æ–°ç‰¹å¾
test_dataset = MyTestDataset(data_path, args)
semantic_id_dict = test_dataset.semantic_id_dict
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šå¤šæ¨¡æ€ç‰¹å¾ç¼ºå¤±
```
è­¦å‘Š: æœªæ‰¾åˆ°å¤šæ¨¡æ€ç‰¹å¾ç›®å½• /data/creative_emb
æ— æ³•è·å–å¤šæ¨¡æ€ç‰¹å¾ï¼Œè·³è¿‡semantic_idç”Ÿæˆ
```

**è§£å†³æ–¹æ¡ˆ**: ç¡®ä¿å¤šæ¨¡æ€ç‰¹å¾æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ã€‚

### é—®é¢˜2ï¼šGPUå†…å­˜ä¸è¶³
```
CUDA out of memory during RQ-VAE training
```

**è§£å†³æ–¹æ¡ˆ**: 
- å‡å°`batch_size`å‚æ•°
- æˆ–è€…è®¾ç½®`device='cpu'`ä½¿ç”¨CPUè®­ç»ƒ

### é—®é¢˜3ï¼šè®­ç»ƒæ—¶é—´è¿‡é•¿
**ä¼˜åŒ–æ–¹æ¡ˆ**:
- è¿›ä¸€æ­¥å‡å°‘`num_epochs`ï¼ˆæœ€ä½10è½®ï¼‰
- å¢å¤§`batch_size`ï¼ˆå¦‚æœå†…å­˜å…è®¸ï¼‰
- å‡å°‘`num_quantizers`ä¸º2æˆ–3

### é—®é¢˜4ï¼šç”Ÿæˆè´¨é‡ä¸ä½³
**æ”¹è¿›æ–¹æ¡ˆ**:
- å¢åŠ `num_epochs`åˆ°30-50è½®
- è°ƒæ•´`commitment_cost`å‚æ•°
- ä½¿ç”¨æ›´å¤šå¤šæ¨¡æ€ç‰¹å¾ID

## ğŸ“ æœ€ä½³å®è·µ

### 1. **ç”Ÿäº§ç¯å¢ƒå»ºè®®**
```bash
# é¦–æ¬¡éƒ¨ç½²æ—¶é¢„ç”Ÿæˆsemantic_id
python evalu/infer.py  # è‡ªåŠ¨ç”Ÿæˆå¹¶ä¿å­˜

# åç»­æ¨ç†ç›´æ¥ä½¿ç”¨
python evalu/infer.py  # å¿«é€ŸåŠ è½½
```

### 2. **å¤šç¯å¢ƒç®¡ç†**
```bash
# å¼€å‘ç¯å¢ƒï¼šå…è®¸è‡ªåŠ¨ç”Ÿæˆ
ALLOW_SEMANTIC_GENERATION=true python evalu/infer.py

# ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨é¢„ç”Ÿæˆæ–‡ä»¶
cp semantic_id_dict.json /production/data/
python evalu/infer.py
```

### 3. **æ€§èƒ½ç›‘æ§**
- ç›‘æ§semantic_idè¦†ç›–ç‡
- è·Ÿè¸ªæ¨ç†è´¨é‡æå‡
- è®°å½•ç”Ÿæˆæ—¶é—´å’Œèµ„æºæ¶ˆè€—

## ğŸ‰ é¢„æœŸæ•ˆæœ

é›†æˆè‡ªåŠ¨semantic_idç”Ÿæˆåï¼š

### æ¨èè´¨é‡æå‡
- **å†·å¯åŠ¨æ”¹å–„**: æ–°ç‰©å“è·å¾—æ›´å¥½çš„è¯­ä¹‰è¡¨ç¤º
- **é•¿å°¾ç‰©å“**: åˆ©ç”¨è¯­ä¹‰ç›¸ä¼¼æ€§æ”¹å–„ç¨€å°‘ç‰©å“æ¨è
- **æ•´ä½“ç²¾åº¦**: è¯­ä¹‰ç‰¹å¾å¢å¼ºæ¨¡å‹ç†è§£èƒ½åŠ›

### è¿ç»´ä¾¿åˆ©æ€§
- **é›¶é…ç½®**: æ— éœ€æ‰‹åŠ¨ç”Ÿæˆsemantic_idæ–‡ä»¶
- **è‡ªåŠ¨é€‚é…**: æ ¹æ®å¯ç”¨çš„å¤šæ¨¡æ€ç‰¹å¾è‡ªåŠ¨è°ƒæ•´
- **æ¸è¿›å¼**: é¦–æ¬¡æ…¢ï¼Œåç»­å¿«çš„ä¼˜é›…ä½“éªŒ

### ç³»ç»Ÿå¯é æ€§
- **ä¼˜é›…é™çº§**: ç”Ÿæˆå¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨é»˜è®¤å€¼
- **é”™è¯¯æ¢å¤**: éƒ¨åˆ†ç‰¹å¾ç¼ºå¤±æ—¶ä»èƒ½æ­£å¸¸å·¥ä½œ
- **å‘åå…¼å®¹**: æ”¯æŒç°æœ‰çš„æ‰‹åŠ¨ç”Ÿæˆæ–¹å¼

---

é€šè¿‡è¿™ç§æ™ºèƒ½åŒ–çš„semantic_idç”Ÿæˆæœºåˆ¶ï¼Œæ¨ç†ç³»ç»Ÿç°åœ¨å…·å¤‡äº†è‡ªä¸»å­¦ä¹ å’Œç‰¹å¾å¢å¼ºçš„èƒ½åŠ›ï¼Œå¤§å¤§ç®€åŒ–äº†éƒ¨ç½²å’Œç»´æŠ¤å·¥ä½œï¼ğŸš€
